name: ðŸš€ CI/CD - Bootcamp bc-express

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '9'

jobs:
  # ValidaciÃ³n de archivos bÃ¡sicos
  validate-structure:
    name: ðŸ“‹ Validate Project Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          echo "Checking required documentation files..."
          test -f README.md || (echo "âŒ README.md missing" && exit 1)
          test -f CONTRIBUTING.md || (echo "âŒ CONTRIBUTING.md missing" && exit 1)
          test -f CODE_OF_CONDUCT.md || (echo "âŒ CODE_OF_CONDUCT.md missing" && exit 1)
          test -f LICENSE || (echo "âŒ LICENSE missing" && exit 1)
          test -f CHANGELOG.md || (echo "âŒ CHANGELOG.md missing" && exit 1)
          echo "âœ… All required files present"

      - name: Check project structure
        run: |
          echo "Checking project structure..."
          test -d _docs || (echo "âŒ _docs directory missing" && exit 1)
          test -d _scripts || (echo "âŒ _scripts directory missing" && exit 1)
          test -d .github || (echo "âŒ .github directory missing" && exit 1)
          echo "âœ… Project structure is valid"

  # Linting de markdown
  markdown-lint:
    name: ðŸ“ Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup markdownlint
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        run: |
          # Lint all markdown files but allow some common issues
          markdownlint . --ignore node_modules --ignore _docs/archive --config .markdownlint.yml || true
          echo "ðŸ“ Markdown linting completed (warnings allowed)"

  # Setup y testing de contenido educativo
  content-validation:
    name: ðŸŽ“ Content Validation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        week: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Check week structure
        run: |
          WEEK="semana-$(printf "%02d" ${{ matrix.week }})"
          echo "Validating structure for $WEEK..."

          if [ -d "$WEEK" ]; then
            echo "âœ… $WEEK directory exists"
            
            # Check required files
            test -f "$WEEK/README.md" || (echo "âŒ $WEEK/README.md missing" && exit 1)
            echo "âœ… $WEEK/README.md exists"
            
            # Check required directories
            test -d "$WEEK/teoria" || echo "âš ï¸  $WEEK/teoria directory missing (optional)"
            test -d "$WEEK/practica" || echo "âš ï¸  $WEEK/practica directory missing (optional)"
            test -d "$WEEK/ejercicios" || echo "âš ï¸  $WEEK/ejercicios directory missing (optional)"
            test -d "$WEEK/proyecto" || echo "âš ï¸  $WEEK/proyecto directory missing (optional)"
            test -d "$WEEK/recursos" || echo "âš ï¸  $WEEK/recursos directory missing (optional)"
            
            echo "âœ… $WEEK structure validation completed"
          else
            echo "âš ï¸  $WEEK directory not found (might not be implemented yet)"
          fi

  # Testing de cÃ³digo de ejemplo
  example-code-test:
    name: ðŸ§ª Example Code Testing
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip-tests]')"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Find and test example projects
        run: |
          echo "Looking for example projects with package.json..."

          # Find all package.json files in semana-* directories
          PROJECTS=$(find . -name "package.json" -path "./semana-*" -not -path "*/node_modules/*")

          if [ -z "$PROJECTS" ]; then
            echo "â„¹ï¸  No example projects found yet"
            exit 0
          fi

          for PROJECT in $PROJECTS; do
            PROJECT_DIR=$(dirname "$PROJECT")
            echo "ðŸ§ª Testing project in $PROJECT_DIR"
            
            cd "$PROJECT_DIR"
            
            # Install dependencies
            pnpm install --frozen-lockfile || pnpm install
            
            # Run linting if available
            if pnpm run lint --if-present; then
              echo "âœ… Linting passed for $PROJECT_DIR"
            fi
            
            # Run tests if available
            if pnpm run test --if-present; then
              echo "âœ… Tests passed for $PROJECT_DIR"
            fi
            
            # Try to build if available
            if pnpm run build --if-present; then
              echo "âœ… Build passed for $PROJECT_DIR"
            fi
            
            cd - > /dev/null
            echo "âœ… Project $PROJECT_DIR validated"
          done

          echo "ðŸŽ‰ All example projects validated successfully"

  # Security scanning
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Link checking
  link-check:
    name: ðŸ”— Link Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup markdown-link-check
        run: npm install -g markdown-link-check

      - name: Check links in markdown files
        run: |
          echo "Checking links in markdown files..."
          find . -name "*.md" -not -path "./node_modules/*" -exec markdown-link-check {} \; || true
          echo "ðŸ”— Link checking completed (failures allowed for now)"

  # Documentation deployment (solo en main)
  deploy-docs:
    name: ðŸ“š Deploy Documentation
    runs-on: ubuntu-latest
    needs: [validate-structure, content-validation]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Generate documentation site
        run: |
          echo "ðŸ“š Generating documentation site..."
          # AquÃ­ se podrÃ­a integrar con un generador de sitios estÃ¡ticos
          # como VitePress, Docusaurus, etc.
          echo "Documentation generation placeholder"

      - name: Deploy to GitHub Pages
        if: false # Disabled for now, enable when ready
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist

  # Notification and reporting
  notify-status:
    name: ðŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs:
      [
        validate-structure,
        markdown-lint,
        content-validation,
        example-code-test,
        security-scan,
        link-check,
      ]
    if: always()
    steps:
      - name: Determine overall status
        id: status
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Some checks failed" >> $GITHUB_OUTPUT
          elif [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "status=cancelled" >> $GITHUB_OUTPUT
            echo "message=â¹ï¸ Some checks were cancelled" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… All checks passed" >> $GITHUB_OUTPUT
          fi

      - name: Create summary
        run: |
          echo "## ðŸš€ CI/CD Results for bc-express" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ steps.status.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ Structure Validation: ${{ needs.validate-structure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Markdown Lint: ${{ needs.markdown-lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ“ Content Validation: ${{ needs.content-validation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª Example Code Test: ${{ needs.example-code-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”’ Security Scan: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— Link Check: ${{ needs.link-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
